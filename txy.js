var rule = {
    title: '腾云驾雾[官]',
    host: 'https://v.qq.com',
    
    // 【新增/保留】筛选菜单配置
    filter: '{"choice":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"83"},{"n":"好评","v":"81"}]},{"key":"iyear","name":"年代","value":[{"n":"全部","v":"-1"},{"n":"2026","v":"2026"},{"n":"2025","v":"2025"},{"n":"2024","v":"2024"},{"n":"2023","v":"2023"},{"n":"2022","v":"2022"},{"n":"2021","v":"2021"},{"n":"2020","v":"2020"},{"n":"2019","v":"2019"},{"n":"2018","v":"2018"},{"n":"2017","v":"2017"},{"n":"2016","v":"2016"},{"n":"2015","v":"2015"}]}],"tv":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"79"},{"n":"好评","v":"16"}]},{"key":"feature","name":"类型","value":[{"n":"全部","v":"-1"},{"n":"爱情","v":"1"},{"n":"古装","v":"2"},{"n":"悬疑","v":"3"},{"n":"都市","v":"4"},{"n":"家庭","v":"5"},{"n":"喜剧","v":"6"},{"n":"传奇","v":"7"},{"n":"武侠","v":"8"},{"n":"军旅","v":"9"},{"n":"权谋","v":"10"},{"n":"革命","v":"11"},{"n":"现实","v":"13"},{"n":"青春","v":"14"},{"n":"猎奇","v":"15"},{"n":"科幻","v":"16"},{"n":"竞技","v":"17"},{"n":"玄幻","v":"18"}]},{"key":"iyear","name":"年代","value":[{"n":"全部","v":"-1"},{"n":"2026","v":"2026"},{"n":"2025","v":"2025"},{"n":"2024","v":"2024"},{"n":"2023","v":"2023"},{"n":"2022","v":"2022"},{"n":"2021","v":"2021"},{"n":"2020","v":"2020"},{"n":"2019","v":"2019"},{"n":"2018","v":"2018"},{"n":"2017","v":"2017"},{"n":"2016","v":"2016"},{"n":"2015","v":"2015"}]}],"movie":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"83"},{"n":"好评","v":"81"}]},{"key":"type","name":"类型","value":[{"n":"全部","v":"-1"},{"n":"犯罪","v":"4"},{"n":"励志","v":"2"},{"n":"喜剧","v":"100004"},{"n":"热血","v":"100061"},{"n":"悬疑","v":"100009"},{"n":"爱情","v":"100005"},{"n":"科幻","v":"100012"},{"n":"恐怖","v":"100010"},{"n":"动画","v":"100015"},{"n":"战争","v":"100006"},{"n":"家庭","v":"100017"},{"n":"剧情","v":"100022"},{"n":"奇幻","v":"100016"},{"n":"武侠","v":"100011"},{"n":"历史","v":"100021"},{"n":"老片","v":"100013"},{"n":"西部","v":"3"},{"n":"记录片","v":"100020"}]},{"key":"year","name":"年代","value":[{"n":"全部","v":"-1"},{"n":"2026","v":"2026"},{"n":"2025","v":"2025"},{"n":"2024","v":"2024"},{"n":"2023","v":"2023"},{"n":"2022","v":"2022"},{"n":"2021","v":"2021"},{"n":"2020","v":"2020"},{"n":"2019","v":"2019"},{"n":"2018","v":"2018"},{"n":"2017","v":"2017"},{"n":"2016","v":"2016"},{"n":"2015","v":"2015"}]}],"variety":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"23"}]},{"key":"iyear","name":"年代","value":[{"n":"全部","v":"-1"},{"n":"2026","v":"2026"},{"n":"2025","v":"2025"},{"n":"2024","v":"2024"},{"n":"2023","v":"2023"},{"n":"2022","v":"2022"},{"n":"2021","v":"2021"},{"n":"2020","v":"2020"},{"n":"2019","v":"2019"},{"n":"2018","v":"2018"},{"n":"2017","v":"2017"},{"n":"2016","v":"2016"},{"n":"2015","v":"2015"}]}],"cartoon":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"83"},{"n":"好评","v":"81"}]},{"key":"area","name":"地区","value":[{"n":"全部","v":"-1"},{"n":"内地","v":"1"},{"n":"日本","v":"2"},{"n":"欧美","v":"3"},{"n":"其他","v":"4"}]},{"key":"type","name":"类型","value":[{"n":"全部","v":"-1"},{"n":"玄幻","v":"9"},{"n":"科幻","v":"4"},{"n":"武侠","v":"13"},{"n":"冒险","v":"3"},{"n":"战斗","v":"5"},{"n":"搞笑","v":"1"},{"n":"恋爱","v":"7"},{"n":"魔幻","v":"6"},{"n":"竞技","v":"20"},{"n":"悬疑","v":"17"},{"n":"日常","v":"15"},{"n":"校园","v":"16"},{"n":"真人","v":"18"},{"n":"推理","v":"14"},{"n":"历史","v":"19"},{"n":"经典","v":"3"},{"n":"其他","v":"12"}]},{"key":"iyear","name":"年代","value":[{"n":"全部","v":"-1"},{"n":"2026","v":"2026"},{"n":"2025","v":"2025"},{"n":"2024","v":"2024"},{"n":"2023","v":"2023"},{"n":"2022","v":"2022"},{"n":"2021","v":"2021"},{"n":"2020","v":"2020"},{"n":"2019","v":"2019"},{"n":"2018","v":"2018"},{"n":"2017","v":"2017"},{"n":"2016","v":"2016"},{"n":"2015","v":"2015"}]}],"child":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"76"},{"n":"好评","v":"20"}]},{"key":"sex","name":"性别","value":[{"n":"全部","v":"-1"},{"n":"女孩","v":"1"},{"n":"男孩","v":"2"}]},{"key":"area","name":"地区","value":[{"n":"全部","v":"-1"},{"n":"内地","v":"3"},{"n":"日本","v":"2"},{"n":"其他","v":"1"}]},{"key":"iyear","name":"年龄段","value":[{"n":"全部","v":"-1"},{"n":"0-3岁","v":"1"},{"n":"4-6岁","v":"2"},{"n":"7-9岁","v":"3"},{"n":"10岁以上","v":"4"},{"n":"全年龄段","v":"7"}]}],"doco":[{"key":"sort","name":"排序","value":[{"n":"最热","v":"75"},{"n":"最新","v":"74"}]},{"key":"itrailer","name":"出品方","value":[{"n":"全部","v":"-1"},{"n":"BBC","v":"1"},{"n":"国家地理","v":"4"},{"n":"HBO","v":"3175"},{"n":"NHK","v":"2"},{"n":"历史频道","v":"7"},{"n":"ITV","v":"3530"},{"n":"探索频道","v":"3174"},{"n":"ZDF","v":"3176"},{"n":"腾讯自制","v":"15"},{"n":"合作机构","v":"6"},{"n":"其他","v":"5"}]},{"key":"type","name":"类型","value":[{"n":"全部","v":"-1"},{"n":"自然","v":"4"},{"n":"美食","v":"10"},{"n":"社会","v":"3"},{"n":"人文","v":"6"},{"n":"历史","v":"1"},{"n":"军事","v":"2"},{"n":"科技","v":"8"},{"n":"财经","v":"14"},{"n":"探险","v":"15"},{"n":"罪案","v":"7"},{"n":"竞技","v":"12"},{"n":"旅游","v":"11"}]}]}',

    /**
     * 核心逻辑：获取列表 (带分页与筛选)
     * @param {string} cateId 分类名
     * @param {number} fypage 当前页码
     * @param {object} fl 筛选对象 (由 UI 传回)
     */
    一级: function(cateId, fypage, fl) {
        let offset = (fypage - 1) * 21;
        
        // 映射筛选参数 (对应你 filter_url 的逻辑)
        let sort = fl.sort || '75';
        let iyear = fl.iyear || '-1';
        let year = fl.year || '-1';
        let type = fl.type || '-1';
        let feature = fl.feature || '-1';
        let area = fl.area || '-1';
        let itrailer = fl.itrailer || '-1';
        let gender = fl.sex || '-1';

        // 构造完整请求 URL
        let url = this.host + '/x/bu/pagesheet/list?_all=1&append=1&channel=' + cateId + 
                  '&listpage=1&offset=' + offset + '&pagesize=21' +
                  '&sort=' + sort + '&iyear=' + iyear + '&year=' + year + 
                  '&itype=' + type + '&ifeature=' + feature + '&iarea=' + area + 
                  '&itrailer=' + itrailer + '&gender=' + gender;

        let html = request(url, { headers: { 'User-Agent': 'PC_UA' } });
        let list = [];
        
        // 正则提取 (原生 QuickJS)
        let regex = /class="list_item".*?data-float="([^"]+)".*?alt="([^"]+)".*?src="([^"]+)"/g;
        let match;
        while ((match = regex.exec(html)) !== null) {
            list.push({
                title: match[2],
                img: match[3].startsWith('//') ? 'https:' + match[3] : match[3],
                url: 'https://node.video.qq.com/x/api/float_vinfo2?cid=' + match[1]
            });
        }
        return list;
    },

    // 详情、搜索、播放解析部分... (保持之前的原生修改版本)
};

/**
 * 2. 詳情與劇集解析 (原生 API 模式)
 * 替代原規則中的 二級 $js.toString 邏輯
 */
function getVodDetail(apiUrl) {
    try {
        let response = request(apiUrl, { headers: { 'User-Agent': UA } });
        let json = JSON.parse(response);
        
        let cid = apiUrl.match(/cid=([^&]+)/)[1];

        // 基礎信息
        let vod = {
            vod_name: json.c.title,
            vod_pic: json.c.pic,
            type_name: json.typ ? json.typ.join("/") : "",
            vod_actor: json.nam ? json.nam.join(",") : "",
            vod_year: json.c.year,
            vod_content: json.c.description,
            vod_remarks: json.rec || ""
        };

        // 劇集處理 (正片與預告分類)
        let vids = json.c.video_ids || [];
        let zpList = []; // 正片
        let ygList = []; // 預告

        // 如果只有一集
        if (vids.length === 1) {
            zpList.push(`正片$https://v.qq.com/x/cover/${cid}/${vids[0]}.html`);
        } else {
            // 多集情況下通常需要進一步獲取劇集標題，此處採用標準拼接
            vids.forEach((vid, index) => {
                zpList.push(`第${index + 1}集$https://v.qq.com/x/cover/${cid}/${vid}.html`);
            });
        }

        vod.vod_play_from = "騰訊視頻";
        vod.vod_play_url = zpList.join("#");

        return vod;
    } catch (e) {
        return { error: e.message };
    }
}

/**
 * 3. 播放地址 Lazy 解析
 * 整合您提供的第三方 API 邏輯
 */
function playParse(webUrl) {
    const parseUrl = "https://cache.json.icu/home/api?type=ys&uid=292796&key=fnoryABDEFJNPQV269&url=";
    let target = webUrl.split('?')[0];
    
    try {
        let res = request(parseUrl + encodeURIComponent(target), { 
            headers: { 'User-Agent': 'okhttp/4.12.0' } 
        });
        let data = JSON.parse(res);
        return data.url || webUrl;
    } catch (e) {
        return webUrl;
    }
}

/**
 * 4. 搜索功能
 * 包含內容摘要與評分提取
 */
function searchVod(wd) {
    let url = `${HOST}/x/search/?q=${encodeURIComponent(wd)}`;
    try {
        let html = request(url, { headers: { 'User-Agent': UA } });
        let results = [];
        
        // 搜索結果正則 (匹配 CID, 標題, 封面, 類型/評分)
        let regex = /class="result_item_v".*?r-data="([^"]+)".*?class="result_title".*?>(.*?)<\/a>.*?src="([^"]+)".*?class="figure_info">([^<]+)</gs;
        let match;
        
        while ((match = regex.exec(html)) !== null) {
            let cidMatch = match[1].match(/cid=([^&]+)/);
            if (cidMatch) {
                results.push({
                    title: match[2].replace(/<\/?[^>]+>/g, ""), // 清除 <em> 高亮標籤
                    img: match[3].startsWith('//') ? 'https:' + match[3] : match[3],
                    desc: match[4].trim(),
                    url: `https://node.video.qq.com/x/api/float_vinfo2?cid=${cidMatch[1]}`
                });
            }
        }
        return results;
    } catch (e) {
        return [];
    }
}
